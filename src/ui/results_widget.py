from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QScrollArea, QGridLayout, QLabel, QPushButton, QFrame, QDialog
)
from PyQt6.QtCore import Qt
import os
from src.ui.player_widget import VideoPlayer

class ResultsWidget(QWidget):
    def __init__(self):
        super().__init__()
        self.init_ui()

    def init_ui(self):
        layout = QVBoxLayout(self)
        
        title = QLabel("Generated Shorts")
        title.setStyleSheet("font-size: 20px; font-weight: bold; color: #ffffff;")
        layout.addWidget(title)
        
        # Scroll Area for Clips
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setStyleSheet("background-color: transparent; border: none;")
        
        self.grid_container = QWidget()
        self.grid_layout = QGridLayout(self.grid_container)
        self.grid_layout.setSpacing(15)
        scroll.setWidget(self.grid_container)
        
        layout.addWidget(scroll)
        
        # Action Buttons
        action_layout = QVBoxLayout()
        self.upload_btn = QPushButton("Upload All to TikTok/Shorts/Reels")
        self.upload_btn.setStyleSheet("""
            QPushButton {
                padding: 15px;
                background-color: #27ae60;
                color: white;
                border: none;
                border-radius: 5px;
                font-weight: bold;
                font-size: 16px;
            }
            QPushButton:hover {
                background-color: #2ecc71;
            }
        """)
        self.upload_btn.clicked.connect(self.on_upload_clicked)
        action_layout.addWidget(self.upload_btn)
        layout.addLayout(action_layout)
        
        self.clip_paths = []

    def on_upload_clicked(self):
        from src.core.uploader import Uploader
        from PyQt6.QtWidgets import QMessageBox
        
        if not self.clip_paths:
            QMessageBox.warning(self, "No Clips", "No clips to upload.")
            return

        uploader = Uploader()
        # For MVP, just upload the first one or all
        # In real app, user would select which ones
        
        count = 0
        for path in self.clip_paths:
            # Simulate upload
            uploader.upload_to_tiktok(path, "Generated by Shorty #shorts")
            count += 1
            
        QMessageBox.information(self, "Upload Complete", f"Uploaded {count} clips to all platforms!")

    def display_clips(self, clip_paths):
        self.clip_paths = clip_paths
        # Clear existing
        for i in reversed(range(self.grid_layout.count())): 
            self.grid_layout.itemAt(i).widget().setParent(None)
            
        row = 0
        col = 0
        max_cols = 3
        
        for path in clip_paths:
            clip_card = self.create_clip_card(path)
            self.grid_layout.addWidget(clip_card, row, col)
            col += 1
            if col >= max_cols:
                col = 0
                row += 1

    def create_clip_card(self, path):
        card = QFrame()
        card.setStyleSheet("""
            QFrame {
                background-color: #333;
                border-radius: 10px;
                padding: 10px;
            }
        """)
        card_layout = QVBoxLayout(card)
        
        # Thumbnail (Placeholder)
        thumb = QLabel("VIDEO PREVIEW")
        thumb.setFixedSize(150, 266) # 9:16 ratio approx
        thumb.setStyleSheet("background-color: #000; color: #555; border-radius: 5px;")
        thumb.setAlignment(Qt.AlignmentFlag.AlignCenter)
        card_layout.addWidget(thumb)
        
        name = QLabel(os.path.basename(path))
        name.setWordWrap(True)
        name.setStyleSheet("color: white; font-size: 12px; margin-top: 5px;")
        card_layout.addWidget(name)
        
        # Buttons container
        buttons_layout = QVBoxLayout()
        buttons_layout.setSpacing(5)
        
        play_btn = QPushButton("▶ Play")
        play_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        play_btn.setStyleSheet("""
            QPushButton {
                background-color: #4a90e2;
                color: white;
                border: none;
                border-radius: 3px;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #357abd;
            }
        """)
        play_btn.clicked.connect(lambda: self.play_video(path))
        buttons_layout.addWidget(play_btn)
        
        download_btn = QPushButton("⬇ Download")
        download_btn.setCursor(Qt.CursorShape.PointingHandCursor)
        download_btn.setStyleSheet("""
            QPushButton {
                background-color: #27ae60;
                color: white;
                border: none;
                border-radius: 3px;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #229954;
            }
        """)
        download_btn.clicked.connect(lambda: self.download_clip(path))
        buttons_layout.addWidget(download_btn)
        
        card_layout.addLayout(buttons_layout)
        
        return card
    
    def download_clip(self, path):
        from PyQt6.QtWidgets import QFileDialog, QMessageBox
        import shutil
        
        if not os.path.exists(path):
            QMessageBox.warning(self, "Error", "File not found.")
            return
        
        # Prompt user to select save location
        default_name = os.path.basename(path)
        save_path, _ = QFileDialog.getSaveFileName(
            self,
            "Save Video",
            os.path.join(os.path.expanduser("~"), "Downloads", default_name),
            "Video Files (*.mp4)"
        )
        
        if save_path:
            try:
                shutil.copy2(path, save_path)
                QMessageBox.information(self, "Success", f"Video saved to:\n{save_path}")
            except Exception as e:
                QMessageBox.critical(self, "Error", f"Failed to save video:\n{str(e)}")

    def play_video(self, path):
        dialog = QDialog(self)
        dialog.setWindowTitle(os.path.basename(path))
        dialog.resize(400, 750) # Vertical aspect ratio
        
        layout = QVBoxLayout(dialog)
        layout.setContentsMargins(0, 0, 0, 0)
        
        player = VideoPlayer(dialog)
        layout.addWidget(player)
        
        player.set_source(path)
        
        dialog.exec()
        
        # Cleanup
        player.stop()
        player.deleteLater()
